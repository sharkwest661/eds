# CORS Issue Fix - April 13, 2025

## Cross-Origin Resource Sharing (CORS) Configuration

### Problem Statement

After implementing HTTP-only cookies and CSRF protection, the application encountered CORS errors during development. The specific error was:

```
Access to XMLHttpRequest at 'https://api.edumetrics.az/csrf-token' from origin 'http://localhost:5173' has been blocked by CORS policy: The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*' when the request's credentials mode is 'include'.
```

This occurred because:

1. The API server was configured to use a wildcard (`*`) for CORS origins
2. Browsers do not allow requests with credentials (cookies) to servers with wildcard CORS settings
3. Our implementation was using `withCredentials: true` for all environments

### Implemented Changes

#### 1. Environment-Aware Configuration

- Created a centralized configuration system in `src/config/appConfig.js`
- Added environment detection (development, production, test)
- Added feature flags and environment-specific settings

#### 2. Development Mode Adjustments

- Disabled credentials for API requests in development mode
- Created fallback mechanisms for CSRF token retrieval
- Added graceful degradation when CSRF endpoints are unavailable

#### 3. API Service Updates

- Updated API and authentication services to use the new configuration
- Made the CSRF setup process more robust with fallbacks
- Added better error handling for initialization

#### 4. App Initialization Improvement

- Enhanced the application initialization process to handle CSRF setup failures
- Added more descriptive logging for development troubleshooting
- Ensured the application can still function when CSRF setup fails

### Files Changed

- `src/config/appConfig.js` (new)
- `src/services/auth/authService.js`
- `src/services/api/apiService.js`
- `src/app/App.jsx`

### Notes for Production Deployment

1. In production, the API server should be configured to:

   - Set `Access-Control-Allow-Origin` to the specific origin of the frontend
   - Include `Access-Control-Allow-Credentials: true` in responses
   - Properly handle preflight requests with appropriate CORS headers

2. The changes implemented maintain security in production while allowing development to proceed smoothly:
   - Production still uses secure HTTP-only cookies
   - Development uses a more permissive approach to avoid CORS issues
   - Feature flags allow easy adjustment as needed

### Testing Requirements

1. Verify login works in development environment
2. Ensure protected routes remain secure
3. Confirm that authenticated API requests succeed
4. Test with production settings to validate full security is maintained
